---
title: "Generation"
output:
  html_document: default
  word_document: default
---
This is the analysis of loan scheduling mechanisms

## Context

```{r message=FALSE}
# Analysis functions
source('func.R')

# Initialise the analysis sequence
lsobs <- read.csv('../data/t24mb.csv', stringsAsFactors=FALSE, na.strings='')
lsov <- newsq('Loan scheduling overview', 'lsobs')

# Initial center candidates
initList <- c('LD.LOANS.AND.DEPOSITS', 'AA.ARRANGEMENT')
lsov <- grow(lsov, initList, ckpt='baseline')
applyLayout(lsov, layout='layout_components')
```

There are too many edges shown and most of them are not particularly useful in this context. Remove these and replace with connections based on record scan

Two clusters linked with CUSTOMER

Add scanned links and divide into two parallel sequences by module

```{r}
# Remove irrelevant centers
voidList <- getCenters(lsov)$name
lsov <- void(lsov, voidList[!voidList %in% c(initList, 'CUSTOMER')])
lsov

# Separate analysis branch for AA
aasch <- void(lsov, 'LD.LOANS.AND.DEPOSITS', name='AA analysis')

aaList <- c('AA.PRODUCT','AA.PROPERTY','AA.ARRANGEMENT.ACTIVITY')
aasch <- grow(aasch, aaList, depth=0)

aasch <- grow(aasch, 'AA.ARRANGEMENT', depth=0, attrs=TRUE)
applySeed(aasch, 390)

# Separate analysis branch for LD
ldsch <- void(lsov, 'AA.ARRANGEMENT', name='LD analysis')
ldsch <- grow(ldsch, 'LD.LOANS.AND.DEPOSITS', depth=0, attrs=TRUE)

# TODO: Remove irrelevant attributes
applyAlternation(ldsch)
```

### AA module exloratory analysis

Number of tables in AA module:

> nrow(aaobs[!is.na(aaobs$mbrp), ])
[1] 2428

as it is not stricty normal... even more

Nonempty tables

> nrow(aaobs[!is.na(aaobs$mbrp) & aaobs$wt_volrec > 0, ])
[1] 1453

Linked to AA.ARRANGEMENT

> getCenters(lsov, ctype = 'entity')$name
 [1] "AA.ARRANGEMENT"               "AA.ARR.PRODUCT.ACCESS"        "AA.ARR.PROXY.PERMISSIONS"     "COMPANY"                     
 [5] "CURRENCY"                     "CUSTOMER"                     "AA.PRODUCT.GROUP"             "AA.PRODUCT.LINE"             
 [9] "AA.PRODUCT"                   "AA.PROPERTY"                  "AA.PRD.CAT.PRODUCT.ACCESS"    "AA.PRD.CAT.PROXY.PERMISSIONS"
[13] "AA.PRD.DES.PRODUCT.ACCESS"    "AA.PRD.DES.PROXY.PERMISSIONS" "AA.PRD.PRF.PRODUCT.ACCESS"    "AA.PRD.PRF.PROXY.PERMISSIONS"
[17] "EB.EXTERNAL.USER"      


## Value date

Add scanned LD links

```{r}

# Add scanned LD links
ldsch <- grow(ldsch, c('LD.LOANS.AND.DEPOSITS'), ckpt='valdate')
ldsch <- grow(ldsch, c('STMT.ENTRY'), ckpt='baseline')

# After checking source tables remove irrelevant entities
keepList <- c('LD.LOANS.AND.DEPOSITS', 'LD.SCHEDULE.DEFINE',
  'STMT.ENTRY', 'CUSTOMER', 'ACCOUNT')
ldsch <- void(ldsch, !(getCenters(ldsch)$name %in% keepList))
ldsch
```

Add scanned AA links
```{r}
keepList <- getCenters(aasch, ctype='entity')$name

aasch <- grow(aasch, 'AA.ARRANGEMENT', ckpt='valdate')
applyAlternation(aasch)

aaVdateList <- c('ACCOUNT', 'STMT.ENTRY',
  'AA.ARR.ACCOUNT', 'AA.ARR.PAYMENT.SCHEDULE', 'AA.SCHEDULED.ACTIVITY')
aasch <- void(aasch, !(getCenters(aasch)$name %in% c(keepList,aaVdateList)))
aasch
```

## Repayment date

New and interesting AA.ACTIVITY.BALANCES>@ID|AA.ARRANGEMENT

Paid back Good Customer

Rescan after COB?

## Maturity date

EB.CONTRACT.BALANCES?

```{r}

```

## Archival

Value tracking.... Statuses, balances?

What can we conclude based on analysis (or in word only?)

