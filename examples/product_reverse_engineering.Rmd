---
title: "Product Reverse Engineering"
output:
  html_document: default
  word_document: default
---

The analysed product (according to  description) targets investors who are willing semi-actively manage their portfolios and are interested in tax reliefs due its classification as a life insurance product (saving for retirement). 

We are interested in maximum expected return of the product if the investor is having a long investment horizon and how it compares to investing into similar financial instruments directly.

Underlying asset performance and portfolio optimisation calculations will be done using functions from *PortfolioAnalytics* package. Data observations will be collected on the fly:

```{r}
# Used packages
suppressMessages(suppressWarnings(library(readxl)))
suppressMessages(suppressWarnings(library(ggplot2)))
suppressMessages(suppressWarnings(library(PortfolioAnalytics)))
# suppressMessages(suppressWarnings(library(tseries)))

# Initiate the analysis sequence for gathering observations
source('../strfa.R')
fp <- analysis('Product Reverse Engineering', datarefl='fpo')
```

# Composition
The product allows to combine a selection of fund shares (positions) into a portfolio:

```{r}
# Observed that the product is comprised of positions in funds
add_obs(fp, list('PRODUCT|contract_number>POSITION', 'type', 'defined'))
add_obs(fp, list('FUND|id>POSITION', 'type', 'defined'))
add_obs(fp, list(object=c('PRODUCT', 'POSITION', 'POSITION>units', 'FUND'),
  property=rep('mbrp', 4), value=rep('product', 4)))

# Collected observations in a long format
fpo

# Load the table which lists funds available for the product
FUND <- read_excel('../data/fp.xlsx', sheet='funds')
str(FUND, strict.width='cut', width=70)

# Observations about fund table
add_obs(fp, cbind(object=paste0('FUND>', names(FUND)),
  property=rep('mbrp', ncol(FUND)), value=rep('product', ncol(FUND))))

# Visualise the product structure
fp <- grow(fp, 'PRODUCT', depth=2, attrs=TRUE)
fp
```

# Performance
Annualised returns are suitable performance measurements for this kind of product and long investment horizon. Historical net asset values are basis for performance calculations:

```{r fig.height=8, fig.width=12}
# Load fund value change data
NAV_HIST <- read_excel('../data/fp.xlsx', sheet='prices')
str(NAV_HIST)

# Present as extended time series object for performance calculation functions
nw <- reshape(NAV_HIST[ ,1:3], direction='wide', idvar=c('date'), timevar='ticker')
NAV_HIST_wide <- xts(nw[, -1], order.by=as.Date(nw[ ,1], '%d.%m.%Y'))
names(NAV_HIST_wide) <- gsub('nav.', '', names(NAV_HIST_wide))

# Populate NA with previous value
NAV_HIST_wide <- na.locf(NAV_HIST_wide)
tail(NAV_HIST_wide[ ,1:8])

# Add historical prices to structure
add_obs(fp, list('NAV_HIST', 'mbrp', 'performance'))
add_obs(fp, list('FUND|id>NAV_HIST', 'type', 'defined'))
add_obs(fp, cbind(object=paste0('NAV_HIST>', names(NAV_HIST)),
  property=rep('mbrp', ncol(NAV_HIST)), value=rep('performance', ncol(NAV_HIST))))

fp <- grow(fp, 'NAV_HIST', attrs=TRUE)

# Separate product and perfomance calculation parts
fp <- applyPartitioning2(fp, partitioning='mbrp')
fp
```

## Default performance
Return of the portfolio comprised of all equally weighted assets

```{r fig.height=8, fig.width=12}
# Daily returns
fp_ret <- Return.calculate(NAV_HIST_wide)

# Annualised returns of years with sufficient data
fund_ret_ann <- function(x) {
  ifelse(sum(!is.na(x)) > 300, Return.annualized(x, scale=length(x)), NA)
}

fp_ret <- lapply(fp_ret, period.apply, endpoints(fp_ret, 'years'), fund_ret_ann)
fp_ret <- do.call(merge, fp_ret)

# Remove funds with too few values
fp_ret <- subset(fp_ret[2:(nrow(fp_ret)-1), ], select=-PCMAGOP)

# Annulised returns of funds in descending order 
fund_ret <- colMeans(fp_ret, na.rm=TRUE)
fund_ret[order(fund_ret, decreasing=TRUE)]

# Equally weighted portfolio return
mean(fund_ret)

# Annulised returns corrected by asset management fee
amfees <- FUND[match(names(fp_ret), FUND$ticker), 'amfee']/100
amfees[is.na(amfees)] <- 0

fp_ret_corr <- fp_ret - amfees
fund_ret_corr <- colMeans(fp_ret_corr, na.rm=TRUE)
fund_ret_corr[order(fund_ret_corr, decreasing=TRUE)]

# Equally weighted corrected portfolio return
exp_ret_def <- mean(fund_ret_corr)
exp_ret_def

# Stucture with attributes for performance analysis and default return
add_obs(fp, list('FUND>return', 'mbrp', 'performance'))
add_obs(fp, list('PRODUCT>expected_return', 'mbrp', 'performance'))
add_obs(fp, list('PRODUCT>expected_return', 'value', round(exp_ret_def, 4)))
fp <- grow(fp, 'FUND', depth=2, attrs=TRUE, vals=TRUE)
fp
```

# Optimised Product

*TODO: Different currencies? Regions? Bonds vs stocks vs commodities?*

*TODO: Checkpoint Performance as well?*

*TODO: Sizing utilised to visualise value?*

```{r fig.height=20}
autoplot(fp_ret_corr)
```
```{r fig.height=8, fig.width=12}
# Create the portfolio specification
port_spec <- portfolio.spec(colnames(fp_ret_corr))

# Add a full investment constraint such that the weights sum to 1
port_spec <- add.constraint(portfolio = port_spec, type = "full_investment")

# Add a long only constraint such that the weight of an asset is between 0 and 1
port_spec <- add.constraint(portfolio = port_spec, type = "long_only")

# Add an objective to minimize portfolio standard deviation
# port_spec <- add.objective(portfolio = port_spec, type = "risk", name = "StdDev")
port_spec <- add.objective(portfolio = port_spec, type = "return", name = "mean")

# Solve the optimization problem
# opt <- optimize.portfolio(fp_ret_corr, portfolio = port_spec, optimize_method = "ROI")
opt <- optimize.portfolio(fp_ret_corr, portfolio = port_spec)

# StdDev.annualized(px_returns)
# SharpeRatio.annualized(px_returns)

# Stucture with attributes optimised performance
add_obs(fp, list('POSITION>weight', 'mbrp', 'performance'))
fp <- grow(fp, 'POSITION', attrs=TRUE, vals=TRUE)
fp
```


# Performance Validation


# Forecasting

*TODO: Variance should be calculated as well?*

# Transactions

*TODO: Purchasing, selling fees? Taxes?*

# Conclusions
```{r fig.height=10, fig.width=14}
signoff(fp, thumb_seq=c(2, 4, 5))
```

# Discussion
NaÃ¯ve analysis: Risk management

Price history does not cover same periods, especially 2008/2009 financial crises

*TODO: Would be nice to choose between partitioning2 colours*
